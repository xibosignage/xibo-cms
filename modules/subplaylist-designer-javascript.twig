{#
/**
 * Copyright (C) 2020 Xibo Signage Ltd
 *
 * Xibo - Digital Signage - http://www.xibo.org.uk
 *
 * This file is part of Xibo.
 *
 * Xibo is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * any later version.
 *
 * Xibo is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with Xibo.  If not, see <http://www.gnu.org/licenses/>.
 */
#}

<script type="text/javascript">

    // Runs after form opens
    function subplaylist_form_edit_open() {

        // Get form object
        var $form = $(this);

        // setup checkbox behaviour for cycle based playback
        formHelpers.setupCheckboxInputFields($(this).find('form'), '#cyclePlaybackEnabled', '.cycle-based-playback');

        // Bind our tooltips
        $form.find('[data-toggle="tooltip"]').tooltip();

        // Translations
        var fillTitle = "{% trans "Fill" %}";
        var fillHelpText = "{% trans "Fill - use the first Playlist to fill any remaining Spots" %}";
        var padTitle = "{% trans "Pad" %}";
        var padHelpText = "{% trans "Pad - use the first Playlist to pad any remaining Spots" %}";
        var repeatTitle = "{% trans "Repeat" %}";
        var repeatHelpText = "{% trans "Repeat - repeat the Widgets in this Playlist until the number of Spots have been filled" %}";

        // Order Clause
        var subPlaylistFields = $(".sub-playlists", $form);

        // Get template
        var subPlaylistFormTemplate = formHelpers.getTemplate('subPlaylistFormTemplate');

        if(subPlaylistFields.length === 0)
            return;

        if($form.data().extra.subPlaylistId.length === 0) {
            // Add a template row
            subPlaylistFields.append(subPlaylistFormTemplate({
                title: "1",
                subPlaylistId: "",
                subPlaylistIdSpots: "",
                subPlaylistIdSpotLength: "",
                subPlaylistIdSpotFill: "",
                buttonGlyph: "fa-plus",
                fillTitle: fillTitle,
                padTitle: padTitle,
                repeatTitle: repeatTitle,
                fillHelpText: fillHelpText,
                padHelpText: padHelpText,
                repeatHelpText: repeatHelpText,
            }));
        } else {
            // For each of the existing codes, create form components
            var i = 0;
            $.each($form.data().extra.subPlaylistId, function(index, field) {
                i++;
                subPlaylistFields.append(subPlaylistFormTemplate({
                    title: i,
                    subPlaylistId: field,
                    subPlaylistIdSpots: ($form.data().extra.subPlaylistOptions[field] === undefined) ? "" : $form.data().extra.subPlaylistOptions[field].subPlaylistIdSpots,
                    subPlaylistIdSpotLength: ($form.data().extra.subPlaylistOptions[field] === undefined) ? "" : $form.data().extra.subPlaylistOptions[field].subPlaylistIdSpotLength,
                    subPlaylistIdSpotFill: ($form.data().extra.subPlaylistOptions[field] === undefined) ? "" : $form.data().extra.subPlaylistOptions[field].subPlaylistIdSpotFill,
                    buttonGlyph: ((i === 1) ? "fa-plus" : "fa-minus"),
                    fillTitle: fillTitle,
                    padTitle: padTitle,
                    repeatTitle: repeatTitle,
                    fillHelpText: fillHelpText,
                    padHelpText: padHelpText,
                    repeatHelpText: repeatHelpText,
                }));
            });
        }

        // Nabble the resulting buttons
        subPlaylistFields.on("click", "button", function(e) {
            e.preventDefault();

            // find the gylph
            if($(this).find("i").hasClass("fa-plus")) {
                subPlaylistFields.append(subPlaylistFormTemplate({
                    title: subPlaylistFields.find('.row-special').length + 1,
                    subPlaylistId: "",
                    subPlaylistIdSpots: "",
                    subPlaylistIdSpotLength: "",
                    subPlaylistIdSpotFill: "",
                    buttonGlyph: "fa-minus",
                    fillTitle: fillTitle,
                    padTitle: padTitle,
                    repeatTitle: repeatTitle,
                    fillHelpText: fillHelpText,
                    padHelpText: padHelpText,
                    repeatHelpText: repeatHelpText,
                }));

                subplaylist_init_row($form);
            } else {
                // Remove this row
                $(this).closest(".row-special").remove();
            }
        });

        subplaylist_init_row($form);
    }

    function subplaylist_init_row($row) {
        $row.find('.subPlaylistSelect').each(function(index, el) {
            var $el = $(el);
            // Get the initial value.
            if ($el.data('fieldId')) {
                $.ajax({
                    method: 'GET',
                    url: '{{ url_for("playlist.search") }}?playlistId=' + $el.data('fieldId'),
                    success: function (response) {
                        if (response.data && response.data.length > 0) {
                            // Append our initial option
                            $el.append('<option value="' + response.data[0].playlistId +
                                '" data-tags="' + response.data[0].tags +
                                '" selected>' + response.data[0].name + '</option>');

                            subplaylist_init_select2($row, $el);
                        } else {
                            // No permissions.
                            $el.parent().append('<input type="hidden" value="' + $el.data('fieldId') + '" name="subPlaylistId[]">' +
                                '<span title="{% trans "You do not have access to this playlist" %}"><i class="fa fa-lock"></i>&nbsp;{% trans "Playlist Id " %}' +
                                $el.data('fieldId') + '</span>');
                            $el.remove();
                        }
                    },
                    error: function () {
                        $el.parent().append('{% trans "An unknown error has occurred. Please refresh" %}');
                    }
                });
            } else {
                subplaylist_init_select2($row, $el);
            }
        });

        $row.find('select[name="subPlaylistIdSpotFill[]"]').select2({
            templateResult: function(state) {
                if (!state.id) {
                    return state.text;
                }
                return $(state.element).data().templateResult;
            },
            dropdownAutoWidth: true,
            minimumResultsForSearch: -1
        });
    }

    function subplaylist_init_select2($row, $el) {
        $el.select2({
            dropdownAutoWidth: true,
            ajax: {
                url: '{{ url_for("playlist.search") }}',
                dataType: 'json',
                data: function (params) {
                    var query = {
                        start: 0,
                        length: 10,
                        name: params.term
                    };
                    if (params.page != null) {
                        query.start = (params.page - 1) * 10;
                    }
                    return query;
                },
                processResults: function (data, params) {
                    var results = [];

                    $.each(data.data, function (index, el) {
                        results.push({
                            id: el.playlistId,
                            text: el.name,
                        });
                    });

                    var page = params.page || 1;
                    page = (page > 1) ? page - 1 : page;

                    if (page === 1 && results.length <= 0) {
                        $row.parent().find('.sub-playlist-no-playlists-message').removeClass('d-none');
                    }

                    return {
                        results: results,
                        pagination: {
                            more: (page * 10 < data.recordsTotal)
                        }
                    };
                }
            },
        });
    }

</script>